<%= form_with(model: post, local: true) do |form| %>
  <% if post.errors.any? %>
    <div class="form-error">
      <h3>âš ï¸ <%= pluralize(post.errors.count, "ì˜¤ë¥˜") %>ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:</h3>
      <ul>
        <% post.errors.each do |error| %>
          <li><%= error.full_message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-group">
    <%= form.label :title, "ì œëª©" %>
    <%= form.text_field :title, class: "form-input", placeholder: "ê¸€ì˜ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" %>
  </div>

  <div class="form-group">
    <%= form.label :post_date, "ë‚ ì§œ" %>
    <%= form.date_field :post_date, class: "form-input", required: true %>
  </div>

  <div class="form-group">
    <%= form.label :category, "ì¹´í…Œê³ ë¦¬" %>
    <div class="category-select">
      <%= form.select :category, Post::CATEGORIES.map { |label, value| [label, value] }, 
          { prompt: "ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”" }, 
          class: "form-select" %>
    </div>
  </div>

  <div class="form-group">
    <%= form.label :images, "ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)" %>
    <div class="image-upload" id="imageUpload">
      <input type="file" id="imageInput" class="form-file-input" accept="image/*" multiple />
      <%= form.file_field :images, class: "form-file-input", accept: "image/*", multiple: true, style: "display: none;" %>
      <span class="file-hint">ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì„¸ìš” (JPG, PNG, GIF - ìµœëŒ€ 5MB)</span>
      <div id="previewContainer" class="preview-container"></div>
    </div>
    <% if post.images.attached? %>
      <div class="image-preview-section" id="existingPreview">
        <h4>ğŸ“¸ ì—…ë¡œë“œëœ ì´ë¯¸ì§€</h4>
        <div class="existing-images">
          <% post.images.each_with_index do |image, index| %>
            <div class="existing-image-item">
              <%= image_tag image, alt: "Image #{index + 1}", class: "existing-preview-img" %>
              <button type="button" class="remove-existing-btn" data-image-id="<%= image.id %>">âœ•</button>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>

  <div class="form-group">
    <%= form.label :body, "ë‚´ìš©" %>
    <%= form.textarea :body, class: "form-textarea", placeholder: "ì˜¤ëŠ˜ì˜ ì´ì•¼ê¸°ë¥¼ ììœ ë¡­ê²Œ ì‘ì„±í•´ë³´ì„¸ìš”...", rows: 12 %>
  </div>

  <div class="form-actions">
    <%= form.submit "ì €ì¥í•˜ê¸°", class: "btn-submit" %>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const imageUpload = document.getElementById('imageUpload');
    const imageInput = document.getElementById('imageInput');
    const formFileInputs = document.querySelectorAll('input[type="file"][accept="image/*"][multiple]');
    const formFileInput = formFileInputs.length > 0 ? formFileInputs[formFileInputs.length - 1] : null;
    const previewContainer = document.getElementById('previewContainer');
    
    if (!formFileInput) {
      console.error('Form file input not found');
      return;
    }

    let selectedFiles = [];

    // íŒŒì¼ ì…ë ¥ ë³€ê²½ ì‹œ ë¯¸ë¦¬ë³´ê¸°
    function handleFileSelect(files) {
      selectedFiles = Array.from(files);
      previewContainer.innerHTML = '';
      
      selectedFiles.forEach((file, index) => {
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            const preview = document.createElement('div');
            preview.className = 'preview-item';
            preview.innerHTML = `
              <div class="preview-thumbnail">
                <img src="${e.target.result}" alt="Preview" class="preview-img">
                <button type="button" class="remove-btn" data-index="${index}">âœ•</button>
              </div>
            `;
            previewContainer.appendChild(preview);
            
            // ì œê±° ë²„íŠ¼
            preview.querySelector('.remove-btn').addEventListener('click', function(e) {
              e.preventDefault();
              selectedFiles.splice(index, 1);
              preview.remove();
              updateFileInput();
            });
          };
          
          reader.readAsDataURL(file);
        }
      });
      
      updateFileInput();
    }

    // íŒŒì¼ ì…ë ¥ ì—…ë°ì´íŠ¸
    function updateFileInput() {
      const dataTransfer = new DataTransfer();
      selectedFiles.forEach(file => dataTransfer.items.add(file));
      imageInput.files = dataTransfer.files;
      if (formFileInput) {
        formFileInput.files = dataTransfer.files;
      }
    }

    // í´ë¦­ìœ¼ë¡œ íŒŒì¼ ì„ íƒ
    imageUpload.addEventListener('click', function(e) {
      if (e.target !== imageInput && !e.target.closest('.remove-btn')) {
        imageInput.click();
      }
    });

    // íŒŒì¼ ì…ë ¥ ë³€ê²½
    imageInput.addEventListener('change', function(e) {
      if (this.files.length > 0) {
        handleFileSelect(this.files);
      }
    });

    // ë“œë˜ê·¸ ì•¤ ë“œë¡­
    imageUpload.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.stopPropagation();
      imageUpload.classList.add('drag-over');
    });

    imageUpload.addEventListener('dragleave', function(e) {
      e.preventDefault();
      e.stopPropagation();
      imageUpload.classList.remove('drag-over');
    });

    imageUpload.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      imageUpload.classList.remove('drag-over');
      
      if (e.dataTransfer.files.length > 0) {
        handleFileSelect(e.dataTransfer.files);
      }
    });

    // ê¸°ì¡´ ì´ë¯¸ì§€ ì œê±° ë²„íŠ¼
    document.querySelectorAll('.remove-existing-btn').forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        const imageId = this.dataset.imageId;
        this.closest('.existing-image-item').remove();
      });
    });
  });
</script>
